# -*- coding: utf-8 -*-
"""mugilml.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1AsePaTkqJqE4GdRFqPsf5VztkqXLwKIk
"""

# Install SHAP
!pip install shap

# Import Dependencies
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import shap
from sklearn.linear_model import LinearRegression, Ridge, Lasso
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.model_selection import train_test_split, RandomizedSearchCV
from sklearn.metrics import r2_score, mean_squared_error
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor, BaggingRegressor
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from xgboost import XGBRegressor

# Load and preprocess dataset
df = pd.read_csv('/content/concrete.csv')
df.drop_duplicates(inplace=True)
df['w/c_ratio'] = df['water'] / df['cement']
df.drop(['water', 'cement'], axis=1, inplace=True)
df['age'] = df['age'].astype(str)
df['slag'] = df['slag'].apply(np.sqrt)
df['superplastic'] = df['superplastic'].apply(np.sqrt)

X = df.drop('strength', axis=1)
y = df['strength']

# Preprocessing pipelines
one_hot_cols = ['age']
numeric_features = ['w/c_ratio', 'slag', 'ash', 'superplastic', 'coarseagg', 'fineagg']

one_hot_transform = Pipeline(steps=[('oneHot', OneHotEncoder(handle_unknown='ignore'))])
numeric_transform = Pipeline(steps=[('scaler', StandardScaler())])

preprocessor = ColumnTransformer(transformers=[
    ('one_hot', one_hot_transform, one_hot_cols),
    ('num', numeric_transform, numeric_features)
])

# XGBoost model + Hyperparameter tuning
xgb = XGBRegressor(objective='reg:squarederror', random_state=42)
param_dist = {
    'n_estimators': [100, 300, 500],
    'max_depth': [4, 6, 8],
    'learning_rate': [0.01, 0.05, 0.1],
    'subsample': [0.7, 1],
    'colsample_bytree': [0.7, 1],
    'gamma': [0, 0.1],
    'reg_alpha': [0, 0.1],
    'reg_lambda': [1, 2]
}
random_search_xgb = RandomizedSearchCV(xgb, param_distributions=param_dist, n_iter=10, cv=3,
                                       scoring='r2', n_jobs=-1, verbose=1, random_state=42)

# Pipeline
xgb_pipeline = Pipeline(steps=[
    ('preprocess', preprocessor),
    ('Regressor', random_search_xgb)
])

# Train-test split
X_train_pipe, X_test_pipe, y_train_pipe, y_test_pipe = train_test_split(X, y, random_state=1, test_size=0.3)
xgb_pipeline.fit(X_train_pipe, y_train_pipe)
best_xgb = random_search_xgb.best_estimator_

# Predict and score
y_preds = xgb_pipeline.predict(X_test_pipe)
pipe_score = r2_score(y_test_pipe, y_preds)
print(f"\n‚úÖ Tuned XGBoost Pipeline Test R¬≤ Score: {pipe_score:.4f}")

# Visual: Actual vs Predicted
plt.figure(figsize=(8, 6))
plt.scatter(y_test_pipe, y_preds, alpha=0.7, edgecolors='k')
plt.xlabel('Actual Strength')
plt.ylabel('Predicted Strength')
plt.title('Actual vs Predicted Concrete Strength')
plt.grid(True)
plt.show()

# Build final model with best estimator
final_model = Pipeline(steps=[
    ('preprocess', preprocessor),
    ('Regressor', best_xgb)
])
final_model.fit(X_train_pipe, y_train_pipe)

# SHAP Explanation
print("\n‚öôÔ∏è Generating SHAP explanations...")

# Transform data for SHAP explainer
X_test_transformed = preprocessor.transform(X_test_pipe)
feature_names = preprocessor.get_feature_names_out()
X_test_df_transformed = pd.DataFrame(X_test_transformed, columns=feature_names)

# Create SHAP explainer
explainer = shap.Explainer(best_xgb.predict, X_test_df_transformed)
shap_values = explainer(X_test_df_transformed)

# SHAP Summary Plot
shap.summary_plot(shap_values, features=X_test_df_transformed)

# --- Manual Input Section ---
def predict_manual_input():
    print("\nüßæ Enter values for manual prediction:")

    user_input = {
        "slag": float(input("Slag (kg/m^3): ")),
        "ash": float(input("Fly Ash (kg/m^3): ")),
        "superplastic": float(input("Superplasticizer (kg/m^3): ")),
        "coarseagg": float(input("Coarse Aggregate (kg/m^3): ")),
        "fineagg": float(input("Fine Aggregate (kg/m^3): ")),
        "water": float(input("Water (kg/m^3): ")),
        "cement": float(input("Cement (kg/m^3): ")),
        "age": input("Age (in days): ")
    }

    # Feature Engineering
    user_input["w/c_ratio"] = user_input["water"] / user_input["cement"]
    user_input["slag"] = np.sqrt(user_input["slag"])
    user_input["superplastic"] = np.sqrt(user_input["superplastic"])
    user_input_df = pd.DataFrame([user_input])
    user_input_df.drop(['water', 'cement'], axis=1, inplace=True)

    # Prediction
    pred = final_model.predict(user_input_df)[0]
    print(f"\nüîÆ Predicted Concrete Strength: {pred:.2f} MPa")

    # SHAP for single prediction
    user_input_transformed = preprocessor.transform(user_input_df)
    user_input_transformed_df = pd.DataFrame(user_input_transformed, columns=feature_names)
    shap_val = explainer(user_input_transformed_df)

    # Waterfall plot without feature_names argument
    shap.plots.waterfall(shap_val[0], show=True)

# Call the manual prediction function
predict_manual_input()



import joblib
joblib.dump(final_model, "final_model.pkl")            # Save model
joblib.dump(preprocessor, "preprocessor.pkl")          # Save preprocessor

# Save transformed sample data for SHAP
X_sample = preprocessor.transform(X_test_pipe)
X_sample_df = pd.DataFrame(X_sample, columns=preprocessor.get_feature_names_out())
X_sample_df.to_csv("X_sample.csv", index=False)

!pip install streamlit shap

import joblib

# Save full pipeline (preprocessor + model)
joblib.dump(final_model, 'concrete_model.pkl')
import streamlit as st
import numpy as np
import pandas as pd
import joblib
import shap
import matplotlib.pyplot as plt

# Load the model
model = joblib.load('concrete_model.pkl')
preprocessor = model.named_steps['preprocess']
feature_names = preprocessor.get_feature_names_out()

# Title
st.title("Concrete Compressive Strength Predictor")
st.markdown("Enter the mix design details below:")

# User Inputs
slag = st.number_input("Slag (kg/m¬≥)", min_value=0.0, value=100.0)
ash = st.number_input("Fly Ash (kg/m¬≥)", min_value=0.0, value=50.0)
superplastic = st.number_input("Superplasticizer (kg/m¬≥)", min_value=0.0, value=10.0)
coarseagg = st.number_input("Coarse Aggregate (kg/m¬≥)", min_value=0.0, value=1000.0)
fineagg = st.number_input("Fine Aggregate (kg/m¬≥)", min_value=0.0, value=800.0)
water = st.number_input("Water (kg/m¬≥)", min_value=1.0, value=180.0)
cement = st.number_input("Cement (kg/m¬≥)", min_value=1.0, value=300.0)
age = st.selectbox("Age (days)", options=['1', '3', '7', '14', '28', '56', '90', '180', '365'])

if st.button("Predict Strength"):
    # Feature Engineering
    w_c_ratio = water / cement
    user_input = {
        'slag': np.sqrt(slag),
        'ash': ash,
        'superplastic': np.sqrt(superplastic),
        'coarseagg': coarseagg,
        'fineagg': fineagg,
        'w/c_ratio': w_c_ratio,
        'age': age
    }

    user_df = pd.DataFrame([user_input])

    # Prediction
    strength = model.predict(user_df)[0]
    st.success(f"Predicted Compressive Strength: **{strength:.2f} MPa**")

    # SHAP Explanation
    explainer = shap.Explainer(model.named_steps['Regressor'].predict, preprocessor.transform(pd.DataFrame([user_input])))
    user_transformed = preprocessor.transform(user_df)
    shap_values = explainer(pd.DataFrame(user_transformed, columns=feature_names))

    st.subheader("Model Explanation")
    st.set_option('deprecation.showPyplotGlobalUse', False)
    shap.plots.waterfall(shap_values[0], show=False)
    st.pyplot(bbox_inches='tight')
